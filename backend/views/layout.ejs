<!DOCTYPE html>
<html lang="<%= lang %>" dir="<%= dir %>">
  <head>
    <meta charset="UTF-8" />
    <title><%= pageTitle %> | <%= t('appTitle') %></title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="/public/css/style.css" />
  </head>
  <body class="tm-body">
    <div class="tm-app-shell">
      <!-- Modern Navbar -->
      <nav class="tm-navbar-new">
        <div class="tm-navbar-container">
          <!-- Sol taraf: Menu ve Logo -->
          <div class="tm-navbar-left">
            <button class="tm-menu-btn" id="sidebarToggle" aria-label="Toggle sidebar">
              <i class="bi bi-list"></i>
            </button>
            <a href="/" class="tm-navbar-brand">
              <div class="tm-logo-wrapper">
                <img
                  src="/public/img/logo.jpg"
                  alt="Logo"
                  class="tm-logo-image"
                  onerror="this.style.display='none'; this.parentElement.classList.add('tm-logo-fallback');"
                />
                <i class="bi bi-check2-circle tm-logo-fallback-icon"></i>
              </div>
              <span class="tm-brand-text"><%= t('appTitle') %></span>
            </a>
          </div>

          <!-- Sağ taraf: Kullanıcı öğeleri -->
          <div class="tm-navbar-right">
            <% if (currentUser) { %>
              <!-- Desktop: Avatar, Bildirim, Dil, Logout -->
              <div class="tm-navbar-items-desktop">
                <div class="tm-user-avatar-new">
                  <% if (currentUser.avatar) { %>
                    <img src="/<%= currentUser.avatar %>" alt="<%= currentUser.username %>" class="tm-avatar-image" />
                  <% } else { %>
                    <div class="tm-avatar-initials">
                      <%= currentUser.username.charAt(0).toUpperCase() %>
                    </div>
                  <% } %>
                </div>
                <a href="/notifications" class="tm-notification-btn">
                  <i class="bi bi-bell"></i>
                  <% if (typeof unreadNotifications !== 'undefined' && unreadNotifications > 0) { %>
                    <span class="tm-notification-badge"><%= unreadNotifications %></span>
                  <% } %>
                </a>
                <div class="tm-dropdown-new">
                  <button class="tm-lang-btn" type="button" id="langDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-globe"></i>
                    <span><%= lang === 'en' ? t('languageEnglish') : lang === 'ar' ? t('languageArabic') : t('languageTurkish') %></span>
                    <i class="bi bi-chevron-down"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="langDropdown">
                    <li><a class="dropdown-item <%= lang === 'en' ? 'active' : '' %>" href="/lang/en"><%= t('languageEnglish') %></a></li>
                    <li><a class="dropdown-item <%= lang === 'ar' ? 'active' : '' %>" href="/lang/ar"><%= t('languageArabic') %></a></li>
                    <li><a class="dropdown-item <%= lang === 'tr' ? 'active' : '' %>" href="/lang/tr"><%= t('languageTurkish') %></a></li>
                  </ul>
                </div>
                <form action="/logout" method="post" class="tm-logout-form">
                  <button type="submit" class="tm-logout-btn">
                    <i class="bi bi-box-arrow-right"></i>
                    <span><%= t('logout') %></span>
                  </button>
                </form>
              </div>

              <!-- Mobile: Avatar, Bildirim, Dil, Logout -->
              <div class="tm-navbar-items-mobile">
                <div class="tm-user-avatar-new-mobile">
                  <% if (currentUser.avatar) { %>
                    <img src="/<%= currentUser.avatar %>" alt="<%= currentUser.username %>" class="tm-avatar-image-mobile" />
                  <% } else { %>
                    <div class="tm-avatar-initials-mobile">
                      <%= currentUser.username.charAt(0).toUpperCase() %>
                    </div>
                  <% } %>
                </div>
                <a href="/notifications" class="tm-notification-btn-mobile">
                  <i class="bi bi-bell"></i>
                  <% if (typeof unreadNotifications !== 'undefined' && unreadNotifications > 0) { %>
                    <span class="tm-notification-badge-mobile"><%= unreadNotifications %></span>
                  <% } %>
                </a>
                <div class="tm-dropdown-new">
                  <button class="tm-lang-btn-mobile" type="button" id="langDropdownMobile" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-globe"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="langDropdownMobile">
                    <li><a class="dropdown-item <%= lang === 'en' ? 'active' : '' %>" href="/lang/en"><%= t('languageEnglish') %></a></li>
                    <li><a class="dropdown-item <%= lang === 'ar' ? 'active' : '' %>" href="/lang/ar"><%= t('languageArabic') %></a></li>
                    <li><a class="dropdown-item <%= lang === 'tr' ? 'active' : '' %>" href="/lang/tr"><%= t('languageTurkish') %></a></li>
                  </ul>
                </div>
                <form action="/logout" method="post" class="tm-logout-form-mobile">
                  <button type="submit" class="tm-logout-btn-mobile" aria-label="<%= t('logout') %>">
                    <i class="bi bi-box-arrow-right"></i>
                  </button>
                </form>
              </div>
            <% } %>
          </div>
        </div>
      </nav>

      <!-- Yeni Sidebar -->
      <div class="tm-sidebar" id="tmSidebar">
        <div class="tm-sidebar-header">
          <h3 class="tm-sidebar-title"><%= t('menu') %></h3>
          <button type="button" class="tm-sidebar-close-btn" id="tmSidebarClose" aria-label="Close sidebar">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <nav class="tm-sidebar-nav">
          <ul class="tm-sidebar-menu">
            <% if (currentUser) { %>
            <li class="tm-sidebar-item">
              <a href="<%= currentUser.role === 'admin' ? '/admin/dashboard' : '/user/tasks' %>" class="tm-sidebar-link">
                <i class="bi bi-speedometer2"></i>
                <span><%= t('dashboard') %></span>
              </a>
            </li>
            <% if (currentUser.role === 'admin') { %>
            <li class="tm-sidebar-item">
              <a href="/admin/tasks" class="tm-sidebar-link">
                <i class="bi bi-list-task"></i>
                <span><%= t('tasks') %></span>
              </a>
            </li>
            <li class="tm-sidebar-item">
              <a href="/admin/reports" class="tm-sidebar-link">
                <i class="bi bi-file-earmark-text"></i>
                <span><%= t('reports') %></span>
              </a>
            </li>
            <li class="tm-sidebar-item">
              <a href="/admin/users" class="tm-sidebar-link">
                <i class="bi bi-people"></i>
                <span><%= t('usersPageTitle') %></span>
              </a>
            </li>
            <% } %>
            <% } %>
          </ul>
        </nav>
      </div>

      <!-- Sidebar Overlay -->
      <div class="tm-sidebar-overlay" id="tmSidebarOverlay"></div>

      <main class="tm-main container">
        <div class="tm-page-wrapper shadow-sm">
          <%- body %>
        </div>
      </main>

      <footer class="tm-footer text-center text-muted small">
        <span>© <%= new Date().getFullYear() %> <%= t('appTitle') %></span>
      </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Navbar yüksekliğini hesapla ve CSS variable olarak ayarla
      function updateNavbarHeight() {
        const navbar = document.querySelector('.tm-navbar-new');
        if (navbar) {
          const height = navbar.offsetHeight;
          document.documentElement.style.setProperty('--navbar-height', height + 'px');
        }
      }

      // Sayfa yüklendiğinde ve resize'da navbar yüksekliğini güncelle
      updateNavbarHeight();
      window.addEventListener('resize', updateNavbarHeight);

      // Yeni Sidebar kontrolü
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebar = document.getElementById('tmSidebar');
      const sidebarOverlay = document.getElementById('tmSidebarOverlay');
      const sidebarClose = document.getElementById('tmSidebarClose');
      const body = document.body;

      function openSidebar() {
        sidebar.classList.add('tm-sidebar-open');
        sidebarOverlay.classList.add('tm-sidebar-overlay-active');
        body.style.overflow = 'hidden';
      }

      function closeSidebar() {
        sidebar.classList.remove('tm-sidebar-open');
        sidebarOverlay.classList.remove('tm-sidebar-overlay-active');
        body.style.overflow = '';
      }

      // Sidebar açma
      if (sidebarToggle) {
        sidebarToggle.addEventListener('click', function() {
          openSidebar();
        });
      }

      // Sidebar kapatma butonu
      if (sidebarClose) {
        sidebarClose.addEventListener('click', function() {
          closeSidebar();
        });
      }

      // Overlay'e tıklandığında kapat
      if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', function() {
          closeSidebar();
        });
      }

      // Sidebar linklerine tıklandığında kapat
      const sidebarLinks = sidebar.querySelectorAll('.tm-sidebar-link');
      sidebarLinks.forEach(link => {
        link.addEventListener('click', function() {
          setTimeout(() => {
            closeSidebar();
          }, 100);
        });
      });

      // Dropdown menüleri navbar dışında açılması için
      document.addEventListener('DOMContentLoaded', function() {
        const langDropdowns = ['langDropdown', 'langDropdownMobile'];
        
        langDropdowns.forEach(function(dropdownId) {
          const dropdownBtn = document.getElementById(dropdownId);
          if (dropdownBtn) {
            dropdownBtn.addEventListener('show.bs.dropdown', function() {
              const dropdownMenu = this.nextElementSibling;
              if (dropdownMenu && dropdownMenu.classList.contains('dropdown-menu')) {
                // Dropdown menüyü body'ye taşı
                document.body.appendChild(dropdownMenu);
                
                // Pozisyonu hesapla
                const rect = this.getBoundingClientRect();
                dropdownMenu.style.position = 'fixed';
                dropdownMenu.style.top = (rect.bottom + window.scrollY + 5) + 'px';
                
                // Sağa hizala (dropdown-menu-end için)
                if (dropdownMenu.classList.contains('dropdown-menu-end')) {
                  dropdownMenu.style.right = (window.innerWidth - rect.right) + 'px';
                  dropdownMenu.style.left = 'auto';
                } else {
                  dropdownMenu.style.left = (rect.left + window.scrollX) + 'px';
                  dropdownMenu.style.right = 'auto';
                }
                
                dropdownMenu.style.zIndex = '10050';
              }
            });
            
            dropdownBtn.addEventListener('hide.bs.dropdown', function() {
              const dropdownMenu = document.querySelector('.dropdown-menu.show');
              if (dropdownMenu) {
                const originalDropdown = this.closest('.dropdown');
                if (originalDropdown && dropdownMenu.parentElement === document.body) {
                  originalDropdown.appendChild(dropdownMenu);
                  dropdownMenu.style.position = '';
                  dropdownMenu.style.top = '';
                  dropdownMenu.style.left = '';
                  dropdownMenu.style.right = '';
                  dropdownMenu.style.zIndex = '';
                }
              }
            });
          }
        });
      });
    </script>
  <!-- Share File Modal -->
  <div class="modal fade" id="shareFileModal" tabindex="-1" aria-labelledby="shareFileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="shareFileModalLabel"><%= t('shareFileTitle') %></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-outline-primary btn-share" data-share="email">
              <i class="bi bi-envelope"></i> <%= t('shareViaEmail') %>
            </button>
            <button type="button" class="btn btn-outline-success btn-share" data-share="whatsapp">
              <i class="bi bi-whatsapp"></i> <%= t('shareViaWhatsApp') %>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Excel export linklerine paylaşım özelliği ekle
    (function() {
      let currentDownloadedFile = null;
      let currentFileName = '';
      
      // Global paylaşım fonksiyonu
      window.shareDownloadedFile = async function() {
        if (!currentDownloadedFile) return;
        
        // Önce Web Share API ile dosyayı doğrudan paylaşmayı dene
        if (navigator.share) {
          try {
            const shareData = {
              title: 'Excel File - ' + currentFileName,
              text: 'Task Manager Excel Export',
              files: [currentDownloadedFile]
            };
            
            // canShare kontrolü
            if (navigator.canShare && navigator.canShare(shareData)) {
              await navigator.share(shareData);
              
              // Toast'u kapat
              const toastElement = document.getElementById('downloadToast');
              if (toastElement) {
                const toastInstance = bootstrap.Toast.getInstance(toastElement);
                if (toastInstance) toastInstance.hide();
              }
              return;
            }
          } catch (error) {
            if (error.name === 'AbortError') {
              // Kullanıcı iptal etti
              return;
            }
            // Dosya paylaşımı desteklenmiyorsa, sunucuya yükleyip link paylaş
            console.log('Direct file share not supported, uploading to server...');
          }
        }
        
        // Dosya paylaşımı desteklenmiyorsa, sunucuya yükle ve link paylaş
        try {
          // Dosyayı base64'e çevir
          const reader = new FileReader();
          reader.onload = async function(e) {
            const base64Data = e.target.result.split(',')[1]; // data:application/...;base64, kısmını kaldır
            
            // Dosyayı sunucuya yükle
            try {
              const response = await fetch('/admin/reports/upload-temp', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  fileData: base64Data,
                  fileName: currentFileName
                })
              });
              
              if (!response.ok) throw new Error('Upload failed');
              
              const result = await response.json();
              const fileUrl = window.location.origin + result.url;
              
              // Modal göster (link ile)
              showShareModal(currentFileName, fileUrl);
            } catch (uploadError) {
              console.error('Upload error:', uploadError);
              // Hata durumunda modal göster
              showShareModal(currentFileName, null);
            }
          };
          
          reader.readAsDataURL(currentDownloadedFile);
        } catch (error) {
          console.error('Share error:', error);
          showShareModal(currentFileName, null);
        }
      };
      
      // Paylaşım modalı göster (fallback)
      function showShareModal(fileName, fileUrl) {
        const shareModal = new bootstrap.Modal(document.getElementById('shareFileModal'));
        shareModal.show();
        
        // Paylaşım butonlarını güncelle
        document.querySelectorAll('.btn-share').forEach(btn => {
          btn.onclick = async function() {
            const shareType = this.dataset.share;
            
            // Önce dosyayı doğrudan paylaşmayı dene
            if (currentDownloadedFile && navigator.share) {
              try {
                const shareData = {
                  title: shareType === 'email' ? 'Excel File - ' + fileName : 'Excel File',
                  text: 'Task Manager Excel Export - ' + fileName,
                  files: [currentDownloadedFile]
                };
                
                if (navigator.canShare && navigator.canShare(shareData)) {
                  await navigator.share(shareData);
                  const modal = bootstrap.Modal.getInstance(document.getElementById('shareFileModal'));
                  if (modal) modal.hide();
                  return;
                }
              } catch (error) {
                if (error.name === 'AbortError') {
                  return;
                }
                // Dosya paylaşımı desteklenmiyorsa, link ile devam et
                console.log('Direct file share failed, using link...');
              }
            }
            
            // Dosya paylaşımı desteklenmiyorsa, link ile paylaş
            const shareUrl = fileUrl || (window.location.origin + window.location.pathname);
            
            if (shareType === 'email') {
              // E-posta için link gönder
              if (navigator.share && fileUrl) {
                try {
                  await navigator.share({
                    title: 'Excel File - ' + fileName,
                    text: 'Task Manager Excel Export - Download the file from:',
                    url: shareUrl
                  });
                } catch (error) {
                  if (error.name !== 'AbortError') {
                    // Fallback: mailto link
                    window.location.href = `mailto:?subject=Excel File - ${fileName}&body=${encodeURIComponent('Please download the Excel file from: ' + shareUrl)}`;
                  }
                }
              } else {
                // Fallback: mailto link
                window.location.href = `mailto:?subject=Excel File - ${fileName}&body=${encodeURIComponent('Please download the Excel file from: ' + shareUrl)}`;
              }
            } else if (shareType === 'whatsapp') {
              // WhatsApp için link paylaş
              if (navigator.share && fileUrl) {
                try {
                  await navigator.share({
                    title: 'Excel File',
                    text: 'Task Manager Excel Export - ' + fileName + ' - Download:',
                    url: shareUrl
                  });
                } catch (error) {
                  if (error.name !== 'AbortError') {
                    // Fallback: WhatsApp web link
                    window.open(`https://wa.me/?text=${encodeURIComponent('Excel File: ' + fileName + ' - Download: ' + shareUrl)}`, '_blank');
                  }
                }
              } else {
                // Fallback: WhatsApp web link
                window.open(`https://wa.me/?text=${encodeURIComponent('Excel File: ' + fileName + ' - Download: ' + shareUrl)}`, '_blank');
              }
            }
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('shareFileModal'));
            if (modal) modal.hide();
          };
        });
      }
      
      // İndirme bildirimi ve paylaşım ikonu göster
      function showDownloadNotification(fileName, file) {
        // Önceki bildirimi kaldır
        const existingToast = document.getElementById('downloadToast');
        if (existingToast) {
          const existingToastInstance = bootstrap.Toast.getInstance(existingToast);
          if (existingToastInstance) existingToastInstance.hide();
          setTimeout(() => existingToast.remove(), 300);
        }
        
        const toast = document.createElement('div');
        toast.id = 'downloadToast';
        toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed bottom-0 end-0 m-3';
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.style.minWidth = '300px';
        toast.style.zIndex = '9999';
        
        const fileDownloadedText = '<%= t("fileDownloaded") %>';
        const shareDownloadedFileText = '<%= t("shareDownloadedFile") %>';
        toast.innerHTML = `
          <div class="d-flex align-items-center">
            <div class="toast-body d-flex align-items-center gap-2">
              <i class="bi bi-check-circle-fill"></i>
              <span>${fileDownloadedText}: ${fileName}</span>
            </div>
            <button type="button" class="btn btn-sm btn-light me-2" onclick="shareDownloadedFile()" title="${shareDownloadedFileText}">
              <i class="bi bi-share-fill"></i>
            </button>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>
        `;
        document.body.appendChild(toast);
        
        // Toast'u göster
        const bsToast = new bootstrap.Toast(toast, { delay: 8000 });
        bsToast.show();
        
        // Toast kapanınca kaldır
        toast.addEventListener('hidden.bs.toast', () => {
          if (toast.parentElement) {
            toast.parentElement.removeChild(toast);
          }
          currentDownloadedFile = null;
          currentFileName = '';
        });
      }
      
      document.addEventListener('DOMContentLoaded', function() {
        const excelLinks = document.querySelectorAll('a[href*="/admin/reports/export"]');
        
        excelLinks.forEach(link => {
          link.addEventListener('click', async function(e) {
            e.preventDefault();
            const exportUrl = this.href;
            
            try {
              // Dosyayı fetch ile blob olarak al
              const response = await fetch(exportUrl);
              if (!response.ok) throw new Error('Download failed');
              
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              
              // Dosya adını oluştur
              let fileName = '';
              const contentDisposition = response.headers.get('content-disposition');
              if (contentDisposition) {
                const fileNameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                if (fileNameMatch) {
                  fileName = fileNameMatch[1].replace(/['"]/g, '');
                }
              }
              if (!fileName) {
                fileName = `gorevler_${new Date().toISOString().slice(0,10)}.xlsx`;
              }
              
              // Dosyayı indir
              const downloadLink = document.createElement('a');
              downloadLink.href = url;
              downloadLink.download = fileName;
              downloadLink.style.display = 'none';
              document.body.appendChild(downloadLink);
              downloadLink.click();
              document.body.removeChild(downloadLink);
              
              // URL'i temizle
              setTimeout(() => window.URL.revokeObjectURL(url), 100);
              
              // Dosyayı sakla (paylaşım için)
              currentDownloadedFile = new File([blob], fileName, { 
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
              });
              currentFileName = fileName;
              
              // İndirme bildirimi göster (paylaşım ikonu ile)
              showDownloadNotification(fileName, currentDownloadedFile);
              
            } catch (error) {
              console.error('Download error:', error);
              // Hata durumunda normal indirme
              const downloadLink = document.createElement('a');
              downloadLink.href = exportUrl;
              downloadLink.download = '';
              downloadLink.style.display = 'none';
              document.body.appendChild(downloadLink);
              downloadLink.click();
              document.body.removeChild(downloadLink);
            }
          });
        });
      });
    })();
  </script>
  </body>
</html>


