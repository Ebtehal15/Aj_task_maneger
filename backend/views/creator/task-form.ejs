<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4">
    <% if (typeof task !== 'undefined') { %>
    <%= t('editTask') %>
    <% } else { %>
    <%= t('createTask') %>
    <% } %>
  </h1>
  <a href="/creator/tasks" class="btn btn-outline-secondary btn-sm">← <%= t('back') %></a>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <form
      method="post"
      action="<%= (typeof task !== 'undefined') ? '/creator/tasks/' + task.id + '/update' : '/creator/tasks' %>"
      enctype="multipart/form-data"
    >
      <!-- Tarih ve Konu Sorumlusu -->
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label"><%= t('tarih') %></label>
          <input
            type="date"
            name="tarih"
            class="form-control"
            value="<%= (typeof task !== 'undefined' && task && task.tarih) ? (typeof task.tarih === 'string' ? task.tarih.slice(0,10) : new Date(task.tarih).toISOString().slice(0,10)) : '' %>"
          />
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label"><%= t('konuSorumlusu') %></label>
          <select name="konu_sorumlusu" id="konuSorumlusuSelect" class="form-select">
            <option value=""><%= t('konuSorumlusu') %></option>
            <% users.forEach(u => { %>
            <option
              value="<%= u.id %>"
              <%= (typeof task !== 'undefined' && task && task.konu_sorumlusu && (String(task.konu_sorumlusu) === String(u.id))) ? 'selected' : '' %>
            >
              <%= u.username %>
            </option>
            <% }) %>
          </select>
          <button type="button" class="btn btn-link btn-sm p-0 mt-1" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="bi bi-plus-circle"></i> <%= t('addUser') %>
          </button>
        </div>
      </div>

      <!-- Sorumlular (3 kişi) -->
      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label"><%= t('sorumlu') %> 1</label>
          <select name="assigned_to" class="form-select" required>
            <option value=""><%= t('assignedTo') %></option>
            <% users.forEach(u => { %>
            <option
              value="<%= u.id %>"
              <%= (typeof task !== 'undefined' && task && task.assigned_to === u.id) ? 'selected' : '' %>
            >
              <%= u.username %>
            </option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label"><%= t('sorumlu2') %></label>
          <select name="sorumlu_2" class="form-select">
            <option value=""><%= t('sorumlu2') %></option>
            <% users.forEach(u => { %>
            <option
              value="<%= u.id %>"
              <%= (typeof task !== 'undefined' && task && task.sorumlu_2 === u.id) ? 'selected' : '' %>
            >
              <%= u.username %>
            </option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label"><%= t('sorumlu3') %></label>
          <select name="sorumlu_3" class="form-select">
            <option value=""><%= t('sorumlu3') %></option>
            <% users.forEach(u => { %>
            <option
              value="<%= u.id %>"
              <%= (typeof task !== 'undefined' && task && task.sorumlu_3 === u.id) ? 'selected' : '' %>
            >
              <%= u.username %>
            </option>
            <% }) %>
          </select>
        </div>
      </div>

      <!-- Bölge, İl, Belediye -->
      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label"><%= t('bolge') %></label>
          <div class="d-flex gap-2">
            <select name="bolge" id="bolgeSelect" class="form-select flex-grow-1">
              <option value=""><%= t('bolge') %></option>
              <% if (typeof regions !== 'undefined' && regions) { %>
                <% regions.forEach(r => { %>
                  <option
                    value="<%= r.name %>"
                    <%= (typeof task !== 'undefined' && task && task.bolge === r.name) ? 'selected' : '' %>
                  >
                    <%= r.name %>
                  </option>
                <% }) %>
              <% } %>
            </select>
            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addRegionModal" style="white-space: nowrap; flex-shrink: 0;">
              <i class="bi bi-plus-circle"></i> <%= t('addRegion') %>
            </button>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label"><%= t('il') %></label>
          <div class="d-flex gap-2">
            <select name="il" id="ilSelect" class="form-select flex-grow-1">
              <option value=""><%= t('il') %></option>
              <% if (typeof cities !== 'undefined' && cities) { %>
                <% cities.forEach(c => { %>
                  <option
                    value="<%= c.name %>"
                    <%= (typeof task !== 'undefined' && task && task.il === c.name) ? 'selected' : '' %>
                  >
                    <%= c.name %>
                  </option>
                <% }) %>
              <% } %>
            </select>
            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addCityModal" style="white-space: nowrap; flex-shrink: 0;">
              <i class="bi bi-plus-circle"></i> <%= t('addCity') %>
            </button>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label"><%= t('belediye') %></label>
          <div class="d-flex gap-2">
            <select name="belediye" id="belediyeSelect" class="form-select flex-grow-1">
              <option value=""><%= t('belediye') %></option>
              <% if (typeof municipalities !== 'undefined' && municipalities) { %>
                <% municipalities.forEach(m => { %>
                  <option
                    value="<%= m.name %>"
                    <%= (typeof task !== 'undefined' && task && task.belediye === m.name) ? 'selected' : '' %>
                  >
                    <%= m.name %>
                  </option>
                <% }) %>
              <% } %>
            </select>
            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addMunicipalityModal" style="white-space: nowrap; flex-shrink: 0;">
              <i class="bi bi-plus-circle"></i> <%= t('addMunicipality') %>
            </button>
          </div>
        </div>
      </div>

      <!-- Departman ve Arşiv -->
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label"><%= t('departman') %></label>
          <select name="departman" class="form-select">
            <option value=""><%= t('departman') %></option>
            <option value="SAHA" <%= (typeof task !== 'undefined' && task && task.departman === 'SAHA') ? 'selected' : '' %>><%= t('departmanSaha') %></option>
            <option value="BELEDİYE" <%= (typeof task !== 'undefined' && task && task.departman === 'BELEDİYE') ? 'selected' : '' %>><%= t('departmanBelediye') %></option>
            <option value="HUKUK" <%= (typeof task !== 'undefined' && task && task.departman === 'HUKUK') ? 'selected' : '' %>><%= t('departmanHukuk') %></option>
            <option value="LİSANS" <%= (typeof task !== 'undefined' && task && task.departman === 'LİSANS') ? 'selected' : '' %>><%= t('departmanLisans') %></option>
            <option value="GENEL" <%= (typeof task !== 'undefined' && task && task.departman === 'GENEL') ? 'selected' : '' %>><%= t('departmanGenel') %></option>
            <option value="İNSAN KAYNAKLARI" <%= (typeof task !== 'undefined' && task && task.departman === 'İNSAN KAYNAKLARI') ? 'selected' : '' %>><%= t('departmanInsanKaynaklari') %></option>
          </select>
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label"><%= t('arsiv') %></label>
          <select name="arsiv" class="form-select">
            <option value="YOK" <%= (typeof task === 'undefined' || !task || !task.arsiv || task.arsiv === 'YOK') ? 'selected' : '' %>><%= t('arsivYok') %></option>
            <option value="VAR" <%= (typeof task !== 'undefined' && task && task.arsiv === 'VAR') ? 'selected' : '' %>><%= t('arsivVar') %></option>
          </select>
        </div>
      </div>

      <!-- Görev Başlığı, İş Konusu ve Açıklama -->
      <div class="mb-3">
        <label class="form-label"><%= t('taskTitle') %></label>
        <input
          type="text"
          name="title"
          class="form-control"
          value="<%= (typeof task !== 'undefined' && task) ? task.title : '' %>"
          required
        />
      </div>
      <div class="mb-3">
        <label class="form-label"><%= t('taskSubject') %></label>
        <input
          type="text"
          name="task_subject"
          class="form-control"
          value="<%= (typeof task !== 'undefined' && task && task.task_subject) ? task.task_subject : '' %>"
        />
      </div>
      <div class="mb-3">
        <label class="form-label">
          <%= t('taskDescription') %>
          <button type="button" class="btn btn-sm btn-link p-0 ms-2 translate-btn" data-text-id="description" title="<%= t('translate') %>">
            <i class="bi bi-translate"></i>
          </button>
        </label>
        <textarea name="description" id="description" rows="4" class="form-control"><%= (typeof task !== 'undefined' && task && task.description) ? task.description : '' %></textarea>
      </div>

      <!-- Tarihler, Durum ve Acil -->
      <div class="row">
        <div class="<%= typeof task !== 'undefined' && task ? 'col-md-3' : 'col-md-4' %> mb-3">
          <label class="form-label"><%= t('verilenIsTarihi') %></label>
          <input
            type="date"
            name="verilen_is_tarihi"
            class="form-control"
            value="<%= (typeof task !== 'undefined' && task && task.verilen_is_tarihi) ? (typeof task.verilen_is_tarihi === 'string' ? task.verilen_is_tarihi.slice(0,10) : new Date(task.verilen_is_tarihi).toISOString().slice(0,10)) : '' %>"
          />
        </div>
        <div class="<%= typeof task !== 'undefined' && task ? 'col-md-3' : 'col-md-4' %> mb-3">
          <label class="form-label"><%= t('tahminiIsBitistarihi') %></label>
          <input
            type="date"
            name="deadline"
            class="form-control"
            value="<%= (typeof task !== 'undefined' && task && task.deadline) ? (typeof task.deadline === 'string' ? task.deadline.slice(0,10) : new Date(task.deadline).toISOString().slice(0,10)) : '' %>"
          />
        </div>
        <div class="<%= typeof task !== 'undefined' && task ? 'col-md-3' : 'col-md-4' %> mb-3">
          <label class="form-label"><%= t('isUrgent') %></label>
          <select name="acil" class="form-select">
            <option value="false" <%= (typeof task === 'undefined' || !task || !task.acil) ? 'selected' : '' %>>
              <%= t('notUrgent') %>
            </option>
            <option value="true" <%= (typeof task !== 'undefined' && task && task.acil) ? 'selected' : '' %>>
              <%= t('urgent') %>
            </option>
          </select>
        </div>
        <% if (typeof task !== 'undefined' && task) { %>
        <div class="col-md-3 mb-3">
          <label class="form-label"><%= t('status') %></label>
          <select name="status" class="form-select">
            <option value="pending" <%= (task.status === 'pending') ? 'selected' : '' %>><%= t('status_pending') %></option>
            <option value="in_progress" <%= (task.status === 'in_progress') ? 'selected' : '' %>><%= t('status_in_progress') %></option>
            <option value="done" <%= (task.status === 'done') ? 'selected' : '' %>><%= t('status_done') %></option>
            <option value="onemli" <%= (task.status === 'onemli') ? 'selected' : '' %>><%= t('statusOnemli') %></option>
          </select>
        </div>
        <% } %>
      </div>

      <% if (typeof task === 'undefined' || !task) { %>
      <!-- Dosya Yükleme (sadece yeni görev oluştururken) -->
      <div class="mb-3">
        <label class="form-label">
          <i class="bi bi-paperclip me-1"></i><%= t('uploadFiles') %>
        </label>
        <input
          type="file"
          name="attachments"
          class="form-control"
          multiple
          accept=".pdf,.xls,.xlsx,.jpg,.jpeg,.png"
          style="border-radius: 8px; border: 2px dashed #d1d5db; padding: 0.5rem;"
        />
        <div class="form-text mt-1" style="font-size: 0.875rem;">
          <i class="bi bi-info-circle me-1"></i>PDF, Excel, JPG, PNG dosyaları yükleyebilirsiniz. Birden fazla dosya seçmek için Ctrl (Windows) veya Cmd (Mac) tuşuna basılı tutarak dosyaları seçin. (Max 20 dosya)
        </div>
      </div>
      <% } %>
      <button type="submit" class="btn btn-primary"><%= t('save') %></button>
    </form>
  </div>
</div>

<% if (typeof task !== 'undefined' && task && typeof updates !== 'undefined' && updates) { %>
<div class="card shadow-sm mt-4">
  <div class="card-body">
    <h2 class="h6 mb-3"><%= t('recentUpdates') %></h2>
    <% if (!updates || !updates.length) { %>
    <p class="text-muted mb-0"><%= t('noUpdates') %></p>
    <% } else { %>
    <ul class="list-group">
      <% updates.forEach(update => { %>
      <li class="list-group-item">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <strong><%= update.username %></strong>
            <span class="text-muted ms-2" style="font-size: 0.875rem;">
              <%
                const formatDateForTurkey = (date) => {
                  if (!date) return '-';
                  try {
                    const dateObj = typeof date === 'string' ? new Date(date) : date;
                    const turkeyOffset = 3 * 60;
                    const utc = dateObj.getTime() + (dateObj.getTimezoneOffset() * 60000);
                    const turkeyTime = new Date(utc + (turkeyOffset * 60000));
                    const year = turkeyTime.getFullYear();
                    const month = String(turkeyTime.getMonth() + 1).padStart(2, '0');
                    const day = String(turkeyTime.getDate()).padStart(2, '0');
                    const hours = String(turkeyTime.getHours()).padStart(2, '0');
                    const minutes = String(turkeyTime.getMinutes()).padStart(2, '0');
                    const seconds = String(turkeyTime.getSeconds()).padStart(2, '0');
                    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                  } catch (err) {
                    return typeof date === 'string' ? date.slice(0, 19).replace('T', ' ') : date.toISOString().slice(0, 19).replace('T', ' ');
                  }
                };
              %>
              <%= formatDateForTurkey(update.created_at) %>
            </span>
          </div>
        </div>
        <div class="small text-muted mt-1">
          <span class="badge status-<%= update.status %> me-2">
            <%= t('status_' + update.status) %>
          </span>
          <% if (update.note) { %>
          <div class="mt-2">
            <span id="note-<%= update.id %>-display"><%= update.note %></span>
            <button type="button" class="btn btn-sm btn-link p-0 ms-2 translate-btn" data-text="<%= update.note || '' %>" data-display-id="note-<%= update.id %>-display" title="<%= t('translate') %>">
              <i class="bi bi-translate"></i>
            </button>
          </div>
          <% } %>
        </div>
      </li>
      <% }) %>
    </ul>
    <% } %>
  </div>
</div>
<% } %>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addUserModalLabel"><%= t('addUser') %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="quickAddUserForm">
          <div class="mb-3">
            <label class="form-label"><%= t('username') %></label>
            <input type="text" name="username" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label"><%= t('email') %> (<%= t('optional') %>)</label>
            <input type="email" name="email" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label"><%= t('password') %></label>
            <input type="password" name="password" class="form-control" required minlength="6">
          </div>
          <div class="mb-3">
            <label class="form-label"><%= t('role') %></label>
            <select name="role" class="form-select" required>
              <option value="user"><%= t('role_user') %></option>
              <option value="admin"><%= t('role_admin') %></option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><%= t('cancel') %></button>
        <button type="button" class="btn btn-primary" id="saveQuickUserBtn"><%= t('save') %></button>
      </div>
    </div>
  </div>
</div>

<!-- Add Municipality Modal -->
<div class="modal fade" id="addMunicipalityModal" tabindex="-1" aria-labelledby="addMunicipalityModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addMunicipalityModalLabel"><%= t('addMunicipality') %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="quickAddMunicipalityForm">
          <div class="mb-3">
            <label class="form-label"><%= t('belediye') %></label>
            <input type="text" name="name" class="form-control" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><%= t('cancel') %></button>
        <button type="button" class="btn btn-primary" id="saveQuickMunicipalityBtn"><%= t('save') %></button>
      </div>
    </div>
  </div>
</div>

<!-- Add Region Modal -->
<div class="modal fade" id="addRegionModal" tabindex="-1" aria-labelledby="addRegionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addRegionModalLabel"><%= t('addRegion') %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="quickAddRegionForm">
          <div class="mb-3">
            <label class="form-label"><%= t('bolge') %></label>
            <input type="text" name="name" class="form-control" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><%= t('cancel') %></button>
        <button type="button" class="btn btn-primary" id="saveQuickRegionBtn"><%= t('save') %></button>
      </div>
    </div>
  </div>
</div>

<!-- Add City Modal -->
<div class="modal fade" id="addCityModal" tabindex="-1" aria-labelledby="addCityModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addCityModalLabel"><%= t('addCity') %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="quickAddCityForm">
          <div class="mb-3">
            <label class="form-label"><%= t('il') %></label>
            <input type="text" name="name" class="form-control" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><%= t('cancel') %></button>
        <button type="button" class="btn btn-primary" id="saveQuickCityBtn"><%= t('save') %></button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const quickAddUserForm = document.getElementById('quickAddUserForm');
  const saveQuickUserBtn = document.getElementById('saveQuickUserBtn');
  const konuSorumlusuSelect = document.getElementById('konuSorumlusuSelect');
  const addUserModalElement = document.getElementById('addUserModal');
  
  if (!addUserModalElement) return;
  
  const addUserModal = new bootstrap.Modal(addUserModalElement);

  if (saveQuickUserBtn) {
    saveQuickUserBtn.addEventListener('click', async function() {
      const formData = new FormData(quickAddUserForm);
      
      // Validate
      if (!formData.get('username') || !formData.get('password')) {
        alert('<%= t("pleaseFillRequiredFields") %>');
        return;
      }

      try {
        const response = await fetch('/admin/users/quick-add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams(formData)
        });

        const result = await response.json();

        if (result.success) {
          // Add new user to all user dropdowns
          const allUserSelects = document.querySelectorAll('select[name="konu_sorumlusu"], select[name="assigned_to"], select[name="sorumlu_2"], select[name="sorumlu_3"]');
          
          allUserSelects.forEach(select => {
            const option = document.createElement('option');
            option.value = result.userId;
            option.textContent = result.username;
            select.appendChild(option);
          });
          
          // Select the new user in konu_sorumlusu dropdown
          konuSorumlusuSelect.value = result.userId;
          
          // Close modal and reset form
          addUserModal.hide();
          quickAddUserForm.reset();
          
          alert('<%= t("userAddedSuccessfully") %>');
        } else {
          alert(result.error || '<%= t("errorAddingUser") %>');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('<%= t("errorAddingUser") %>');
      }
    });
  }

  // Municipality quick add
  const quickAddMunicipalityForm = document.getElementById('quickAddMunicipalityForm');
  const saveQuickMunicipalityBtn = document.getElementById('saveQuickMunicipalityBtn');
  const belediyeSelect = document.getElementById('belediyeSelect');
  const addMunicipalityModalElement = document.getElementById('addMunicipalityModal');
  
  if (addMunicipalityModalElement) {
    const addMunicipalityModal = new bootstrap.Modal(addMunicipalityModalElement);

    if (saveQuickMunicipalityBtn) {
      saveQuickMunicipalityBtn.addEventListener('click', async function() {
        const formData = new FormData(quickAddMunicipalityForm);
        
        // Validate
        if (!formData.get('name')) {
          alert('<%= t("pleaseFillRequiredFields") %>');
          return;
        }

        try {
          const response = await fetch('/admin/municipalities/quick-add', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(formData)
          });

          const result = await response.json();

          if (result.success) {
            // Add new municipality to dropdown
            const option = document.createElement('option');
            option.value = result.name;
            option.textContent = result.name;
            belediyeSelect.appendChild(option);
            
            // Select the new municipality
            belediyeSelect.value = result.name;
            
            // Close modal and reset form
            addMunicipalityModal.hide();
            quickAddMunicipalityForm.reset();
            
            alert('<%= t("municipalityAddedSuccessfully") %>');
          } else {
            alert(result.error || '<%= t("errorAddingMunicipality") %>');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('<%= t("errorAddingMunicipality") %>');
        }
      });
    }
  }

  // Region quick add
  const quickAddRegionForm = document.getElementById('quickAddRegionForm');
  const saveQuickRegionBtn = document.getElementById('saveQuickRegionBtn');
  const bolgeSelect = document.getElementById('bolgeSelect');
  const addRegionModalElement = document.getElementById('addRegionModal');
  
  if (addRegionModalElement) {
    const addRegionModal = new bootstrap.Modal(addRegionModalElement);

    if (saveQuickRegionBtn) {
      saveQuickRegionBtn.addEventListener('click', async function() {
        const formData = new FormData(quickAddRegionForm);
        
        // Validate
        if (!formData.get('name')) {
          alert('<%= t("pleaseFillRequiredFields") %>');
          return;
        }

        try {
          const response = await fetch('/admin/regions/quick-add', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(formData)
          });

          const result = await response.json();

          if (result.success) {
            // Add new region to dropdown
            const option = document.createElement('option');
            option.value = result.name;
            option.textContent = result.name;
            bolgeSelect.appendChild(option);
            
            // Select the new region
            bolgeSelect.value = result.name;
            
            // Close modal and reset form
            addRegionModal.hide();
            quickAddRegionForm.reset();
            
            alert('<%= t("regionAddedSuccessfully") %>');
          } else {
            alert(result.error || '<%= t("errorAddingRegion") %>');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('<%= t("errorAddingRegion") %>');
        }
      });
    }
  }

  // City quick add
  const quickAddCityForm = document.getElementById('quickAddCityForm');
  const saveQuickCityBtn = document.getElementById('saveQuickCityBtn');
  const ilSelect = document.getElementById('ilSelect');
  const addCityModalElement = document.getElementById('addCityModal');
  
  if (addCityModalElement) {
    const addCityModal = new bootstrap.Modal(addCityModalElement);

    if (saveQuickCityBtn) {
      saveQuickCityBtn.addEventListener('click', async function() {
        const formData = new FormData(quickAddCityForm);
        
        // Validate
        if (!formData.get('name')) {
          alert('<%= t("pleaseFillRequiredFields") %>');
          return;
        }

        try {
          const response = await fetch('/admin/cities/quick-add', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(formData)
          });

          const result = await response.json();

          if (result.success) {
            // Add new city to dropdown
            const option = document.createElement('option');
            option.value = result.name;
            option.textContent = result.name;
            ilSelect.appendChild(option);
            
            // Select the new city
            ilSelect.value = result.name;
            
            // Close modal and reset form
            addCityModal.hide();
            quickAddCityForm.reset();
            
            alert('<%= t("cityAddedSuccessfully") %>');
          } else {
            alert(result.error || '<%= t("errorAddingCity") %>');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('<%= t("errorAddingCity") %>');
        }
      });
    }
  }

  // Translate functionality
  const translateBtns = document.querySelectorAll('.translate-btn');
  const currentLang = '<%= typeof lang !== "undefined" ? lang : "tr" %>';
  
  translateBtns.forEach(btn => {
    btn.addEventListener('click', async function() {
      const textId = this.getAttribute('data-text-id');
      
      if (!textId) return;
      
      const targetElement = document.getElementById(textId);
      if (!targetElement) return;
      
      const textToTranslate = targetElement.value || targetElement.textContent;
      
      if (!textToTranslate || !textToTranslate.trim()) {
        alert('Çevrilecek metin bulunamadı');
        return;
      }
      
      const originalIcon = this.querySelector('i');
      const originalClass = originalIcon.className;
      originalIcon.className = 'bi bi-hourglass-split';
      this.disabled = true;
      
      try {
        const response = await fetch('/admin/translate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            text: textToTranslate,
            targetLang: currentLang
          })
        });
        
        const result = await response.json();
        
        if (result.success && result.translated) {
          targetElement.value = result.translated;
        } else {
          alert('Çeviri başarısız oldu');
        }
      } catch (error) {
        console.error('Translate error:', error);
        alert('Çeviri sırasında hata oluştu');
      } finally {
        originalIcon.className = originalClass;
        this.disabled = false;
      }
    });
  });
});
</script>

