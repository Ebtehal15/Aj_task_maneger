<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4">
    <% if (typeof task !== 'undefined') { %>
    <%= t('editTask') %>
    <% } else { %>
    <%= t('createTask') %>
    <% } %>
  </h1>
  <a href="/admin/dashboard" class="btn btn-outline-secondary btn-sm">← <%= t('back') %></a>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <form
      method="post"
      action="<%= (typeof task !== 'undefined') ? '/admin/tasks/' + task.id : '/admin/tasks' %>"
      <% if (typeof task === 'undefined' || !task) { %>enctype="multipart/form-data"<% } %>
    >
      <!-- Tarih ve Konu Sorumlusu -->
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label"><%= t('tarih') %></label>
          <input
            type="date"
            name="tarih"
            class="form-control"
            value="<%= (typeof task !== 'undefined' && task && task.tarih) ? (typeof task.tarih === 'string' ? task.tarih.slice(0,10) : new Date(task.tarih).toISOString().slice(0,10)) : '' %>"
          />
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label"><%= t('konuSorumlusu') %></label>
          <select name="konu_sorumlusu" id="konuSorumlusuSelect" class="form-select">
            <option value=""><%= t('konuSorumlusu') %></option>
            <% users.forEach(u => { %>
            <option
              value="<%= u.id %>"
              <%= (typeof task !== 'undefined' && task && task.konu_sorumlusu == u.id) ? 'selected' : '' %>
            >
              <%= u.username %>
            </option>
            <% }) %>
          </select>
          <button type="button" class="btn btn-link btn-sm p-0 mt-1" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="bi bi-plus-circle"></i> <%= t('addUser') %>
          </button>
        </div>
      </div>

      <!-- Sorumlular (3 kişi) -->
      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label"><%= t('sorumlu') %> 1</label>
          <select name="assigned_to" class="form-select" required>
            <option value=""><%= t('assignedTo') %></option>
            <% users.forEach(u => { %>
            <option
              value="<%= u.id %>"
              <%= (typeof task !== 'undefined' && task && task.assigned_to === u.id) ? 'selected' : '' %>
            >
              <%= u.username %>
            </option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label"><%= t('sorumlu2') %></label>
          <select name="sorumlu_2" class="form-select">
            <option value=""><%= t('sorumlu2') %></option>
            <% users.forEach(u => { %>
            <option
              value="<%= u.id %>"
              <%= (typeof task !== 'undefined' && task && task.sorumlu_2 === u.id) ? 'selected' : '' %>
            >
              <%= u.username %>
            </option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label"><%= t('sorumlu3') %></label>
          <select name="sorumlu_3" class="form-select">
            <option value=""><%= t('sorumlu3') %></option>
            <% users.forEach(u => { %>
            <option
              value="<%= u.id %>"
              <%= (typeof task !== 'undefined' && task && task.sorumlu_3 === u.id) ? 'selected' : '' %>
            >
              <%= u.username %>
            </option>
            <% }) %>
          </select>
        </div>
      </div>

      <!-- Bölge, İl, Belediye -->
      <div class="row">
        <div class="col-md-4 mb-3">
          <label class="form-label"><%= t('bolge') %></label>
          <input
            type="text"
            name="bolge"
            class="form-control"
            value="<%= (typeof task !== 'undefined' && task && task.bolge) ? task.bolge : '' %>"
          />
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label"><%= t('il') %></label>
          <input
            type="text"
            name="il"
            class="form-control"
            value="<%= (typeof task !== 'undefined' && task && task.il) ? task.il : '' %>"
          />
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label"><%= t('belediye') %></label>
          <input
            type="text"
            name="belediye"
            class="form-control"
            value="<%= (typeof task !== 'undefined' && task && task.belediye) ? task.belediye : '' %>"
          />
        </div>
      </div>

      <!-- Departman ve Arşiv -->
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label"><%= t('departman') %></label>
          <select name="departman" class="form-select">
            <option value=""><%= t('departman') %></option>
            <option value="SAHA" <%= (typeof task !== 'undefined' && task && task.departman === 'SAHA') ? 'selected' : '' %>><%= t('departmanSaha') %></option>
            <option value="BELEDİYE" <%= (typeof task !== 'undefined' && task && task.departman === 'BELEDİYE') ? 'selected' : '' %>><%= t('departmanBelediye') %></option>
            <option value="HUKUK" <%= (typeof task !== 'undefined' && task && task.departman === 'HUKUK') ? 'selected' : '' %>><%= t('departmanHukuk') %></option>
          </select>
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label"><%= t('arsiv') %></label>
          <select name="arsiv" class="form-select">
            <option value="YOK" <%= (typeof task === 'undefined' || !task || !task.arsiv || task.arsiv === 'YOK') ? 'selected' : '' %>><%= t('arsivYok') %></option>
            <option value="VAR" <%= (typeof task !== 'undefined' && task && task.arsiv === 'VAR') ? 'selected' : '' %>><%= t('arsivVar') %></option>
          </select>
        </div>
      </div>

      <!-- Konu (Title) ve İş Konusu (Description) -->
      <div class="mb-3">
        <label class="form-label"><%= t('taskTitle') %> (Konu)</label>
        <input
          type="text"
          name="title"
          class="form-control"
          value="<%= (typeof task !== 'undefined' && task) ? task.title : '' %>"
          required
        />
      </div>
      <div class="mb-3">
        <label class="form-label"><%= t('taskDescription') %> (İş Konusu)</label>
        <textarea name="description" rows="4" class="form-control"><%= (typeof task !== 'undefined' && task && task.description) ? task.description : '' %></textarea>
      </div>

      <!-- Tarihler, Durum ve Acil -->
      <div class="row">
        <div class="<%= typeof task !== 'undefined' && task ? 'col-md-3' : 'col-md-4' %> mb-3">
          <label class="form-label"><%= t('verilenIsTarihi') %></label>
          <input
            type="date"
            name="verilen_is_tarihi"
            class="form-control"
            value="<%= (typeof task !== 'undefined' && task && task.verilen_is_tarihi) ? (typeof task.verilen_is_tarihi === 'string' ? task.verilen_is_tarihi.slice(0,10) : new Date(task.verilen_is_tarihi).toISOString().slice(0,10)) : '' %>"
          />
        </div>
        <div class="<%= typeof task !== 'undefined' && task ? 'col-md-3' : 'col-md-4' %> mb-3">
          <label class="form-label"><%= t('tahminiIsBitistarihi') %></label>
          <input
            type="date"
            name="deadline"
            class="form-control"
            value="<%= (typeof task !== 'undefined' && task && task.deadline) ? (typeof task.deadline === 'string' ? task.deadline.slice(0,10) : new Date(task.deadline).toISOString().slice(0,10)) : '' %>"
          />
        </div>
        <div class="<%= typeof task !== 'undefined' && task ? 'col-md-3' : 'col-md-4' %> mb-3">
          <label class="form-label"><%= t('isUrgent') %></label>
          <select name="acil" class="form-select">
            <option value="false" <%= (typeof task === 'undefined' || !task || !task.acil) ? 'selected' : '' %>>
              <%= t('notUrgent') %>
            </option>
            <option value="true" <%= (typeof task !== 'undefined' && task && task.acil) ? 'selected' : '' %>>
              <%= t('urgent') %>
            </option>
          </select>
        </div>
        <% if (typeof task !== 'undefined' && task) { %>
        <div class="col-md-3 mb-3">
          <label class="form-label"><%= t('status') %></label>
          <select name="status" class="form-select">
            <option value="pending" <%= (task.status === 'pending') ? 'selected' : '' %>><%= t('status_pending') %></option>
            <option value="in_progress" <%= (task.status === 'in_progress') ? 'selected' : '' %>><%= t('status_in_progress') %></option>
            <option value="done" <%= (task.status === 'done') ? 'selected' : '' %>><%= t('status_done') %></option>
            <option value="onemli" <%= (task.status === 'onemli') ? 'selected' : '' %>><%= t('statusOnemli') %></option>
          </select>
        </div>
        <% } %>
      </div>

      <!-- Dosya Yükleme -->
      <% if (typeof task === 'undefined' || !task) { %>
      <div class="mb-3">
        <label class="form-label"><%= t('uploadFiles') %></label>
        <input
          type="file"
          name="attachments"
          class="form-control"
          multiple
          accept=".pdf,.xls,.xlsx,.jpg,.jpeg,.png"
        />
      </div>
      <% } %>
      <button class="btn btn-primary"><%= t('save') %></button>
    </form>
  </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addUserModalLabel"><%= t('addUser') %></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="quickAddUserForm">
          <div class="mb-3">
            <label class="form-label"><%= t('username') %></label>
            <input type="text" name="username" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label"><%= t('email') %> (<%= t('optional') %>)</label>
            <input type="email" name="email" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label"><%= t('password') %></label>
            <input type="password" name="password" class="form-control" required minlength="6">
          </div>
          <div class="mb-3">
            <label class="form-label"><%= t('role') %></label>
            <select name="role" class="form-select" required>
              <option value="user"><%= t('role_user') %></option>
              <option value="admin"><%= t('role_admin') %></option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><%= t('cancel') %></button>
        <button type="button" class="btn btn-primary" id="saveQuickUserBtn"><%= t('save') %></button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const quickAddUserForm = document.getElementById('quickAddUserForm');
  const saveQuickUserBtn = document.getElementById('saveQuickUserBtn');
  const konuSorumlusuSelect = document.getElementById('konuSorumlusuSelect');
  const addUserModalElement = document.getElementById('addUserModal');
  
  if (!addUserModalElement) return;
  
  const addUserModal = new bootstrap.Modal(addUserModalElement);

  if (saveQuickUserBtn) {
    saveQuickUserBtn.addEventListener('click', async function() {
      const formData = new FormData(quickAddUserForm);
      
      // Validate
      if (!formData.get('username') || !formData.get('password')) {
        alert('<%= t("pleaseFillRequiredFields") %>');
        return;
      }

      try {
        const response = await fetch('/admin/users/quick-add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams(formData)
        });

        const result = await response.json();

        if (result.success) {
          // Add new user to all user dropdowns
          const allUserSelects = document.querySelectorAll('select[name="konu_sorumlusu"], select[name="assigned_to"], select[name="sorumlu_2"], select[name="sorumlu_3"]');
          
          allUserSelects.forEach(select => {
            const option = document.createElement('option');
            option.value = result.userId;
            option.textContent = result.username;
            select.appendChild(option);
          });
          
          // Select the new user in konu_sorumlusu dropdown
          konuSorumlusuSelect.value = result.userId;
          
          // Close modal and reset form
          addUserModal.hide();
          quickAddUserForm.reset();
          
          alert('<%= t("userAddedSuccessfully") %>');
        } else {
          alert(result.error || '<%= t("errorAddingUser") %>');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('<%= t("errorAddingUser") %>');
      }
    });
  }
});
</script>

